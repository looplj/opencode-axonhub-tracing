## OVERVIEW

OpenCode plugin (`opencode-axonhub-tracing`) — injects `AH-Thread-Id` and `AH-Trace-Id` headers into every LLM request via the `chat.headers` hook. Header keys configurable via env vars.

## STRUCTURE

```text
./
├── index.ts              # ALL plugin logic (single file, ~30 lines)
├── index.test.ts         # Tests (bun:test)
├── dist/                 # Build output (generated by prepublishOnly)
│   ├── index.js
│   └── index.d.ts
├── tsconfig.json         # Dev config (ES2022, strict, Bun types)
├── tsconfig.build.json   # Build config (declaration-only → dist/)
└── package.json          # npm: opencode-axonhub-tracing
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Plugin logic | `index.ts` | Single default export, `chat.headers` hook |
| Header defaults | `index.ts:3-4` | `AH-Thread-Id`, `AH-Trace-Id` |
| Env var config | `index.ts:16-17` | `OPENCODE_AXONHUB_TRACING_THREAD_HEADER`, `..._TRACE_HEADER` |
| Tests | `index.test.ts` | Tests the hook via `OpenCodeAxonHubTracing({} as any)` |
| Build output | `dist/` | generated during publish build |
| Plugin type defs | `node_modules/@opencode-ai/plugin/dist/index.d.ts` | `Plugin`, `Hooks`, `PluginInput` types |

## CONVENTIONS

- Default export only — OpenCode calls ALL named exports as plugin functions
- `UPPER_SNAKE_CASE` constants, `camelCase` functions
- No semicolons
- `typeof x === "string"` over `x?.trim()` for env var safety
- Tests use `as any` for mock objects, `afterEach` for env cleanup
- Bun-first: `bun:test`, `bun build`, `bunx tsc`

## ANTI-PATTERNS (THIS PROJECT)

- **NEVER** add named exports — OpenCode will call them as plugins with `PluginInput`, causing runtime crashes
- **NEVER** assume `output` or `output.headers` exists — guard with `if (!input?.sessionID || !output?.headers) return`
- **NEVER** use `envValue?.trim()` on env vars — use `typeof envValue === "string"` (env values can be non-string at runtime)
- **NEVER** wrap hook body in try/catch to swallow errors silently — use early-return guards instead

## COMMANDS

```bash
bun install          # Install deps
bun test             # Run tests
bun run build        # Build → dist/index.js + dist/index.d.ts
bunx tsc --noEmit    # Type check only
npm publish           # Publish (runs prepublishOnly → build)
```

## NOTES

- `npm publish` / `npm pack` honor `"files": ["dist"]`; `prepublishOnly` runs build so generated `dist/` is included without committing build artifacts
- Reference implementation: `npm i opencode-axonhub-tracing` (different package, same pattern, confirmed working)
- Plugin signature: `async (_input: PluginInput) => Hooks` — the `_input` param provides `client`, `project`, `$`, `directory`, `worktree`
- Thread ID = `input.sessionID`, Trace ID = `input.message?.id` (only injected when present)
